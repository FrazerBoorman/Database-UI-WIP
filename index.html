<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AVD DB Layout Designer – Lotus Style</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #2f3b4f;
      --canvas-bg: #d6dde7;
      --canvas-border: #6b7280;
      --grid-color: rgba(107,114,128,0.35);
      --group-border: #1f2937;
      --group-header-bg: #374151;
      --group-header-text: #e5e7eb;
      --group-body-bg: #f3f4f6;
      --text-main: #111827;
      --palette-bg: #e5e7eb;
      --palette-border: #9ca3af;
      --palette-item-bg: #f9fafb;
      --palette-item-border: #9ca3af;
      --debug-bg: #111827;
      --debug-text: #d1d5db;
      --grid-size: 10px;
      --group-radius: 4px;
      --header-height: 22px;
      --shadow: 0 2px 6px rgba(15,23,42,0.4);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    body {
      background: radial-gradient(circle at top, #1f2933 0%, #111827 55%, #020617 100%);
      color: var(--text-main);
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .toolbar {
      height: 40px;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, #111827, #1f2937);
      color: #e5e7eb;
      border-bottom: 1px solid #000;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title {
      font-weight: 600;
      font-size: 13px;
    }

    .btn {
      border-radius: 4px;
      border: 1px solid #4b5563;
      padding: 3px 7px;
      font-size: 11px;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn:hover {
      background: #1f2937;
    }

    .btn-small {
      font-size: 10px;
      padding: 2px 5px;
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 4fr) minmax(220px, 1fr);
      gap: 6px;
      padding: 6px;
    }

    /* Canvas */
    .canvas-wrapper {
      position: relative;
      background: var(--canvas-bg);
      border-radius: 6px;
      border: 1px solid var(--canvas-border);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.3), var(--shadow);
      overflow: hidden;
    }

    .canvas-toolbar {
      position: absolute;
      top: 4px;
      left: 6px;
      z-index: 5;
      display: flex;
      gap: 4px;
      font-size: 11px;
      align-items: center;
    }

    .canvas-toolbar span {
      font-size: 10px;
      opacity: 0.8;
    }

    .canvas {
      position: absolute;
      inset: 0;
      padding: 26px 6px 6px 6px;
      overflow: auto;
      background:
        linear-gradient(to bottom, rgba(255,255,255,0.7), rgba(214,221,231,0.95)),
        repeating-linear-gradient(to right, var(--grid-color) 0, var(--grid-color) 1px, transparent 1px, transparent var(--grid-size)),
        repeating-linear-gradient(to bottom, var(--grid-color) 0, var(--grid-color) 1px, transparent 1px, transparent var(--grid-size));
    }

    .group-box {
      position: absolute;
      min-width: 160px;
      min-height: 60px;
      border-radius: var(--group-radius);
      border: 1px solid var(--group-border);
      background: var(--group-body-bg);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      user-select: none;
    }

    .group-header {
      height: var(--header-height);
      background: var(--group-header-bg);
      color: var(--group-header-text);
      border-bottom: 1px solid #000;
      border-top-left-radius: var(--group-radius);
      border-top-right-radius: var(--group-radius);
      display: flex;
      align-items: center;
      padding: 0 4px;
      gap: 4px;
      cursor: move;
      font-size: 11px;
    }

    .collapse-icon {
      width: 14px;
      text-align: center;
      font-size: 11px;
      cursor: pointer;
    }

    .group-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .group-title[contenteditable="true"] {
      outline: 1px dashed #93c5fd;
      background: rgba(15,23,42,0.6);
    }

    .colour-chip {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid #000;
      cursor: pointer;
      flex-shrink: 0;
    }

    .group-body {
      flex: 1;
      padding: 4px;
      font-size: 11px;
      overflow: auto;
      position: relative;
    }

    .group-body.collapsed {
      display: none;
    }

    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      right: 0;
      bottom: 0;
      cursor: se-resize;
      background: linear-gradient(135deg, #6b7280, #111827);
      border-top: 1px solid #9ca3af;
      border-left: 1px solid #9ca3af;
      border-bottom-right-radius: var(--group-radius);
    }

    /* Fields inside groups */
    .field-row {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
      gap: 3px;
    }

    .field-label {
      min-width: 80px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .field-input {
      flex: 1;
      font-size: 11px;
      padding: 2px 3px;
      border-radius: 2px;
      border: 1px solid #9ca3af;
      background: #ffffff;
    }

    /* Floating fields on canvas */
    .floating-field {
      position: absolute;
      display: flex;
      align-items: center;
      font-size: 11px;
      padding: 2px 4px;
      border-radius: 3px;
      background: #fefce8;
      border: 1px solid #facc15;
      box-shadow: 0 1px 3px rgba(15,23,42,0.35);
      cursor: move;
      user-select: none;
      gap: 4px;
    }

    .floating-field-label {
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .floating-field-input {
      width: 80px;
      font-size: 11px;
      padding: 1px 3px;
      border-radius: 2px;
      border: 1px solid #9ca3af;
      background: #ffffff;
    }

    /* Palette */
    .palette {
      background: var(--palette-bg);
      border-radius: 6px;
      border: 1px solid var(--palette-border);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.3), var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .palette-header {
      padding: 5px 6px;
      font-size: 11px;
      border-bottom: 1px solid #9ca3af;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    .palette-search {
      width: 100%;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #9ca3af;
      background: #f9fafb;
    }

    .palette-body {
      flex: 1;
      padding: 4px;
      overflow: auto;
      font-size: 11px;
    }

    .palette-section-title {
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin: 4px 0 2px 0;
      color: #4b5563;
    }

    .palette-item {
      padding: 2px 4px;
      margin-bottom: 2px;
      border-radius: 3px;
      border: 1px solid var(--palette-item-border);
      background: var(--palette-item-bg);
      cursor: grab;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .palette-item-code {
      font-size: 9px;
      opacity: 0.6;
    }

    .palette-item:hover {
      background: #e0f2fe;
      border-color: #38bdf8;
    }

    .palette-footer {
      padding: 4px 6px;
      border-top: 1px solid #9ca3af;
      font-size: 10px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    input[type="file"] {
      font-size: 10px;
    }

    .hidden-input {
      display: none;
    }

    /* Debug */
    .debug {
      height: 70px;
      background: var(--debug-bg);
      color: var(--debug-text);
      font-size: 11px;
      padding: 3px 6px;
      overflow: auto;
      border-top: 1px solid #000;
    }

    .debug-line {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    /* Drag hover indication for group bodies */
    .group-body.drag-over {
      outline: 2px dashed #2563eb;
      outline-offset: -2px;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="toolbar-left">
      <span class="title">AVD DB Layout Designer</span>
      <button class="btn btn-small" type="button" onclick="resetLayout()">Reset Layout</button>
      <button class="btn btn-small" type="button" onclick="downloadLayout()">Save Layout (JSON)</button>
      <label class="btn btn-small" style="cursor:pointer;">
        Load Layout
        <input id="layoutFile" type="file" accept=".json" class="hidden-input" onchange="loadLayoutFromFile(event)" />
      </label>
    </div>
    <div class="toolbar-right">
      <div class="pill">
        <span class="pill-dot"></span>
        <span>Lotus-style Designer v0.1</span>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="canvas-wrapper">
      <div class="canvas-toolbar">
        <span>Drag group boxes. Drag fields from the right onto a group or canvas. Resize from bottom-right corner.</span>
      </div>
      <div id="canvas" class="canvas"></div>
    </div>

    <aside class="palette">
      <div class="palette-header">
        <span>Field Bank</span>
      </div>
      <div style="padding: 0 6px 4px 6px;">
        <input id="paletteSearch" type="text" class="palette-search" placeholder="Filter fields..." oninput="filterPalette()" />
      </div>
      <div id="paletteBody" class="palette-body">
        <!-- Filled by JS -->
      </div>
      <div class="palette-footer">
        <span>Drag to place</span>
        <div style="display:flex;gap:4px;align-items:center;">
          <button class="btn btn-small" type="button" onclick="downloadLayout()">Save</button>
          <label class="btn btn-small" style="cursor:pointer;">
            Load
            <input id="layoutFile2" type="file" accept=".json" class="hidden-input" onchange="loadLayoutFromFile(event)" />
          </label>
        </div>
      </div>
    </aside>
  </div>

  <div id="debug" class="debug"></div>
</div>

<script>
  // ===== CONFIG =====
  const GRID_SIZE = 10;

  // A sample bank of fields – real DBF fields underneath, nicer labels on top.
  const FIELD_BANK = [
    { code: "company", label: "Venue / Company" },
    { code: "address", label: "Address Line 1" },
    { code: "address1", label: "Address Line 2" },
    { code: "address2", label: "Address Line 3" },
    { code: "area", label: "Area" },
    { code: "town", label: "Town" },
    { code: "county", label: "County" },
    { code: "country", label: "Country" },
    { code: "postcode", label: "Postcode" },
    { code: "classifica", label: "Classification" },
    { code: "identifica", label: "Identification" },
    { code: "market", label: "Market" },
    { code: "denominati", label: "Denomination" },
    { code: "consultant", label: "Consultant" },
    { code: "lead_from", label: "Lead From" },
    { code: "status_of_", label: "Status of Job" },
    { code: "gp__", label: "GP %" },
    { code: "gp___act", label: "GP £ (Actual)" },
    { code: "revenue", label: "Revenue £" },
    { code: "first_name", label: "Contact 1 – First Name" },
    { code: "last_name", label: "Contact 1 – Last Name" },
    { code: "job_title", label: "Contact 1 – Job Title" },
    { code: "mobile_1", label: "Contact 1 – Mobile" },
    { code: "email", label: "Contact 1 – Email" },
    { code: "phone_1", label: "Contact 1 – Phone" },
    { code: "first_nam2", label: "Contact 2 – First Name" },
    { code: "last_name_", label: "Contact 2 – Last Name" },
    { code: "other_cont", label: "Contact 2 – Other Contact" },
    { code: "phone_2", label: "Contact 2 – Phone" },
    { code: "email_2", label: "Contact 2 – Email" },
    { code: "contact_3", label: "Contact 3 – Name" },
    { code: "phone_3", label: "Contact 3 – Phone" },
    { code: "email_3", label: "Contact 3 – Email" },
    { code: "contact_4", label: "Contact 4 – Minister / Other" },
    { code: "phone_4", label: "Contact 4 – Phone" },
    { code: "email_4", label: "Contact 4 – Email" },
    { code: "notes_main", label: "Main Notes" },
    { code: "service_is", label: "Service Issue Notes" },
    { code: "job_costs", label: "Job Costs Notes" },
    { code: "recce_feed", label: "Recce Feedback" },
    { code: "wsm_member", label: "WSM Member (Tick)" },
    { code: "negotiatin", label: "Negotiable (Tick)" },
    { code: "avw", label: "AVW (Tick)" }
  ];

  // 10 group boxes, loosely named; you can rename in the UI
  const GROUP_DEFAULTS = [
    "Venue Details",
    "Primary Contact",
    "Secondary Contact",
    "Third Contact",
    "Fourth / Minister",
    "Sales & GP",
    "Service & Dates",
    "Flags & Territories",
    "Internal Notes",
    "Spare Group"
  ];

  let groups = [];       // {id, title, colour, x,y,w,h, collapsed, fields:[{fieldCode,label}]}
  let floatingFields = []; // {id, fieldCode,label,x,y}

  let dragState = null;    // group drag
  let resizeState = null;  // group resize
  let floatDragState = null; // floating field drag

  // ===== UTIL =====
  function log(msg) {
    const dbg = document.getElementById("debug");
    const line = document.createElement("div");
    line.className = "debug-line";
    const ts = new Date().toLocaleTimeString();
    line.textContent = `[${ts}] ${msg}`;
    dbg.prepend(line);
  }

  function snap(v) {
    return Math.round(v / GRID_SIZE) * GRID_SIZE;
  }

  function makeId(prefix) {
    return prefix + "_" + Math.random().toString(36).slice(2, 9);
  }

  // ===== INIT GROUPS & PALETTE =====
  function initGroups() {
    const canvas = document.getElementById("canvas");
    canvas.innerHTML = "";
    groups = [];

    const cols = 2;
    const colWidth = 300;
    const rowHeight = 140;
    let idx = 0;

    for (let i = 0; i < 10; i++) {
      const id = "group" + (i + 1);
      const title = GROUP_DEFAULTS[i] || ("Group " + (i + 1));
      const col = i % cols;
      const row = Math.floor(i / cols);
      const x = 20 + col * (colWidth + 20);
      const y = 20 + row * (rowHeight + 10);
      const w = colWidth;
      const h = rowHeight;

      const colour = "#4b5563"; // default header tint, will be mapped to background

      const group = { id, title, colour, x, y, w, h, collapsed: false, fields: [] };
      groups.push(group);

      const el = createGroupElement(group);
      canvas.appendChild(el);
    }

    // Layer holder for floating fields
    const floatLayer = document.createElement("div");
    floatLayer.id = "floatingLayer";
    floatLayer.style.position = "absolute";
    floatLayer.style.inset = "0";
    floatLayer.style.pointerEvents = "none"; // children will re-enable
    canvas.appendChild(floatLayer);

    floatingFields = [];
  }

  function createGroupElement(group) {
    const el = document.createElement("div");
    el.className = "group-box";
    el.dataset.id = group.id;
    updateGroupPosition(el, group);

    const header = document.createElement("div");
    header.className = "group-header";

    const collapseIcon = document.createElement("div");
    collapseIcon.className = "collapse-icon";
    collapseIcon.textContent = group.collapsed ? "▸" : "▾";
    collapseIcon.addEventListener("click", function(e) {
      e.stopPropagation();
      toggleGroupCollapse(group.id);
    });

    const titleSpan = document.createElement("div");
    titleSpan.className = "group-title";
    titleSpan.textContent = group.title;
    titleSpan.title = "Double-click to rename";
    titleSpan.addEventListener("dblclick", function(e) {
      e.stopPropagation();
      titleSpan.contentEditable = "true";
      titleSpan.focus();
      const range = document.createRange();
      range.selectNodeContents(titleSpan);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    });

    titleSpan.addEventListener("blur", function() {
      titleSpan.contentEditable = "false";
      const newTitle = titleSpan.textContent.trim() || group.id;
      group.title = newTitle;
      titleSpan.textContent = newTitle;
      log("Renamed " + group.id + " to '" + newTitle + "'");
    });

    titleSpan.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        titleSpan.blur();
      }
    });

    const colourChip = document.createElement("div");
    colourChip.className = "colour-chip";
    colourChip.style.background = group.colour;
    colourChip.title = "Change group header colour";

    const colourInput = document.createElement("input");
    colourInput.type = "color";
    colourInput.value = group.colour;
    colourInput.className = "hidden-input";

    colourChip.addEventListener("click", function(e) {
      e.stopPropagation();
      colourInput.click();
    });

    colourInput.addEventListener("input", function() {
      group.colour = colourInput.value;
      colourChip.style.background = group.colour;
      header.style.background = group.colour;
      log("Colour changed for " + group.id + " to " + group.colour);
    });

    header.appendChild(collapseIcon);
    header.appendChild(titleSpan);
    header.appendChild(colourChip);
    header.appendChild(colourInput);

    const body = document.createElement("div");
    body.className = "group-body";
    body.dataset.groupId = group.id;
    if (group.collapsed) {
      body.classList.add("collapsed");
    }

    // Drag to move group
    header.addEventListener("mousedown", function(e) {
      if (e.target === colourChip || e.target === colourInput || titleSpan.isContentEditable) return;
      const rect = el.getBoundingClientRect();
      const canvasRect = document.getElementById("canvas").getBoundingClientRect();
      dragState = {
        groupId: group.id,
        offsetX: e.clientX - rect.left + canvasRect.left,
        offsetY: e.clientY - rect.top + canvasRect.top
      };
      e.preventDefault();
    });

    // Allow drop inside group
    body.addEventListener("dragover", function(e) {
      e.preventDefault();
      body.classList.add("drag-over");
    });
    body.addEventListener("dragleave", function() {
      body.classList.remove("drag-over");
    });
    body.addEventListener("drop", function(e) {
      e.preventDefault();
      body.classList.remove("drag-over");
      const data = e.dataTransfer.getData("application/json") || e.dataTransfer.getData("text/plain");
      if (!data) return;
      let field;
      try {
        field = JSON.parse(data);
      } catch {
        const code = data;
        field = FIELD_BANK.find(f => f.code === code) || { code, label: code };
      }
      addFieldToGroup(group.id, field.code, field.label);
    });

    // Resize handle
    const resizeHandle = document.createElement("div");
    resizeHandle.className = "resize-handle";
    resizeHandle.addEventListener("mousedown", function(e) {
      e.stopPropagation();
      const rect = el.getBoundingClientRect();
      resizeState = {
        groupId: group.id,
        startX: e.clientX,
        startY: e.clientY,
        startW: rect.width,
        startH: rect.height
      };
      e.preventDefault();
    });

    el.appendChild(header);
    el.appendChild(body);
    el.appendChild(resizeHandle);

    return el;
  }

  function updateGroupPosition(el, group) {
    el.style.left = snap(group.x) + "px";
    el.style.top = snap(group.y) + "px";
    el.style.width = snap(group.w) + "px";
    el.style.height = snap(group.h) + "px";
    const header = el.querySelector(".group-header");
    if (header) header.style.background = group.colour;
  }

  function toggleGroupCollapse(groupId) {
    const group = groups.find(g => g.id === groupId);
    if (!group) return;
    group.collapsed = !group.collapsed;
    const el = document.querySelector(`.group-box[data-id="${groupId}"]`);
    if (!el) return;
    const body = el.querySelector(".group-body");
    const icon = el.querySelector(".collapse-icon");
    if (group.collapsed) {
      body.classList.add("collapsed");
      icon.textContent = "▸";
    } else {
      body.classList.remove("collapsed");
      icon.textContent = "▾";
    }
    log((group.collapsed ? "Collapsed " : "Expanded ") + groupId);
  }

  // ===== FIELD BANK / PALETTE =====
  function initPalette() {
    const body = document.getElementById("paletteBody");
    body.innerHTML = "";

    const groups = [
      { title: "Venue", filter: f => ["company","address","address1","address2","area","town","county","country","postcode"].includes(f.code) },
      { title: "Classification / Sales", filter: f => ["classifica","identifica","market","denominati","status_of_","gp__","gp___act","revenue"].includes(f.code) },
      { title: "Contacts", filter: f => f.label.startsWith("Contact") },
      { title: "Notes / Other", filter: f => !f.label.startsWith("Contact") && !["company","address","address1","address2","area","town","county","country","postcode","classifica","identifica","market","denominati","status_of_","gp__","gp___act","revenue"].includes(f.code) }
    ];

    groups.forEach(group => {
      const fields = FIELD_BANK.filter(group.filter);
      if (!fields.length) return;
      const titleEl = document.createElement("div");
      titleEl.className = "palette-section-title";
      titleEl.textContent = group.title;
      body.appendChild(titleEl);

      fields.forEach(f => {
        const item = document.createElement("div");
        item.className = "palette-item";
        item.draggable = true;
        item.dataset.code = f.code;
        item.dataset.label = f.label;

        const left = document.createElement("span");
        left.textContent = f.label;

        const right = document.createElement("span");
        right.className = "palette-item-code";
        right.textContent = f.code;

        item.appendChild(left);
        item.appendChild(right);

        item.addEventListener("dragstart", function(e) {
          const payload = JSON.stringify({ code: f.code, label: f.label });
          e.dataTransfer.setData("application/json", payload);
          e.dataTransfer.setData("text/plain", f.code);
        });

        body.appendChild(item);
      });
    });
  }

  function filterPalette() {
    const query = (document.getElementById("paletteSearch").value || "").toLowerCase();
    const body = document.getElementById("paletteBody");
    const items = body.querySelectorAll(".palette-item");
    const titles = body.querySelectorAll(".palette-section-title");

    items.forEach(item => {
      const label = item.firstChild.textContent.toLowerCase();
      const code = item.dataset.code.toLowerCase();
      item.style.display = (label.includes(query) || code.includes(query)) ? "" : "none";
    });

    titles.forEach(title => {
      // show title only if any following items visible until next title
      let next = title.nextElementSibling;
      let anyVisible = false;
      while (next && !next.classList.contains("palette-section-title")) {
        if (next.style.display !== "none") {
          anyVisible = true;
          break;
        }
        next = next.nextElementSibling;
      }
      title.style.display = anyVisible ? "" : "none";
    });
  }

  // ===== ADD FIELD TO GROUP / CANVAS =====
  function addFieldToGroup(groupId, fieldCode, label) {
    const group = groups.find(g => g.id === groupId);
    if (!group) return;

    if (!label) {
      const fromBank = FIELD_BANK.find(f => f.code === fieldCode);
      label = fromBank ? fromBank.label : fieldCode;
    }

    // Avoid duplicates of same field in same group
    if (group.fields.some(f => f.fieldCode === fieldCode)) {
      log(`Field ${fieldCode} already in ${group.title}`);
      return;
    }

    group.fields.push({ fieldCode, label });

    const groupEl = document.querySelector(`.group-box[data-id="${groupId}"]`);
    if (!groupEl) return;
    const body = groupEl.querySelector(".group-body");

    const row = document.createElement("div");
    row.className = "field-row";
    row.dataset.fieldCode = fieldCode;

    const lbl = document.createElement("div");
    lbl.className = "field-label";
    lbl.textContent = label;

    const input = document.createElement("input");
    input.className = "field-input";
    input.placeholder = label;
    input.dataset.fieldCode = fieldCode;

    row.appendChild(lbl);
    row.appendChild(input);
    body.appendChild(row);

    log(`Added field ${fieldCode} → ${group.title}`);
  }

  function addFloatingField(fieldCode, label, x, y) {
    if (!label) {
      const fromBank = FIELD_BANK.find(f => f.code === fieldCode);
      label = fromBank ? fromBank.label : fieldCode;
    }
    const id = makeId("float");
    const field = { id, fieldCode, label, x: snap(x), y: snap(y) };
    floatingFields.push(field);

    const layer = document.getElementById("floatingLayer");
    const el = document.createElement("div");
    el.className = "floating-field";
    el.dataset.id = id;
    el.style.left = field.x + "px";
    el.style.top = field.y + "px";
    el.style.pointerEvents = "auto";

    const lbl = document.createElement("span");
    lbl.className = "floating-field-label";
    lbl.textContent = label;

    const input = document.createElement("input");
    input.className = "floating-field-input";
    input.placeholder = label;
    input.dataset.fieldCode = fieldCode;

    el.appendChild(lbl);
    el.appendChild(input);

    el.addEventListener("mousedown", function(e) {
      const rect = el.getBoundingClientRect();
      const canvasRect = document.getElementById("canvas").getBoundingClientRect();
      floatDragState = {
        id,
        offsetX: e.clientX - rect.left + canvasRect.left,
        offsetY: e.clientY - rect.top + canvasRect.top
      };
      e.preventDefault();
    });

    layer.appendChild(el);
    log(`Added floating field ${fieldCode}`);
  }

  // ===== CANVAS DROP HANDLING =====
  function initCanvasDrop() {
    const canvas = document.getElementById("canvas");

    canvas.addEventListener("dragover", function(e) {
      e.preventDefault();
    });

    canvas.addEventListener("drop", function(e) {
      e.preventDefault();
      // If dropped on group body, that handler will have fired; ignore here.
      const data = e.dataTransfer.getData("application/json") || e.dataTransfer.getData("text/plain");
      if (!data) return;
      let field;
      try {
        field = JSON.parse(data);
      } catch {
        const code = data;
        field = FIELD_BANK.find(f => f.code === code) || { code, label: code };
      }

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      addFloatingField(field.code, field.label, x, y);
    });
  }

  // ===== GLOBAL MOUSE MOVE / UP FOR DRAG & RESIZE =====
  document.addEventListener("mousemove", function(e) {
    const canvas = document.getElementById("canvas");
    const canvasRect = canvas.getBoundingClientRect();

    if (dragState) {
      const group = groups.find(g => g.id === dragState.groupId);
      const el = document.querySelector(`.group-box[data-id="${dragState.groupId}"]`);
      if (!group || !el) return;
      let x = e.clientX - dragState.offsetX;
      let y = e.clientY - dragState.offsetY;
      // Keep within canvas somewhat
      x = Math.max(0, x);
      y = Math.max(0, y);
      x = Math.min(canvasRect.width - 80, x);
      y = Math.min(canvasRect.height - 40, y);
      group.x = snap(x);
      group.y = snap(y);
      el.style.left = group.x + "px";
      el.style.top = group.y + "px";
    }

    if (resizeState) {
      const group = groups.find(g => g.id === resizeState.groupId);
      const el = document.querySelector(`.group-box[data-id="${resizeState.groupId}"]`);
      if (!group || !el) return;
      let w = resizeState.startW + (e.clientX - resizeState.startX);
      let h = resizeState.startH + (e.clientY - resizeState.startY);
      w = Math.max(160, w);
      h = Math.max(60, h);
      group.w = snap(w);
      group.h = snap(h);
      el.style.width = group.w + "px";
      el.style.height = group.h + "px";
    }

    if (floatDragState) {
      const field = floatingFields.find(f => f.id === floatDragState.id);
      const el = document.querySelector(`.floating-field[data-id="${floatDragState.id}"]`);
      if (!field || !el) return;
      let x = e.clientX - floatDragState.offsetX;
      let y = e.clientY - floatDragState.offsetY;
      x = Math.max(0, x);
      y = Math.max(0, y);
      x = Math.min(canvasRect.width - 60, x);
      y = Math.min(canvasRect.height - 20, y);
      field.x = snap(x);
      field.y = snap(y);
      el.style.left = field.x + "px";
      el.style.top = field.y + "px";
    }
  });

  document.addEventListener("mouseup", function() {
    if (dragState) {
      log("Group moved: " + dragState.groupId);
      dragState = null;
    }
    if (resizeState) {
      log("Group resized: " + resizeState.groupId);
      resizeState = null;
    }
    if (floatDragState) {
      log("Floating field moved: " + floatDragState.id);
      floatDragState = null;
    }
  });

  // ===== LAYOUT SAVE / LOAD =====
  function collectLayout() {
    const layout = {
      groups: [],
      floatingFields: []
    };

    groups.forEach(g => {
      const el = document.querySelector(`.group-box[data-id="${g.id}"]`);
      const body = el ? el.querySelector(".group-body") : null;
      const fields = [];
      if (body) {
        body.querySelectorAll(".field-row").forEach(row => {
          fields.push({
            fieldCode: row.dataset.fieldCode,
            label: row.querySelector(".field-label").textContent
          });
        });
      }
      layout.groups.push({
        id: g.id,
        title: g.title,
        colour: g.colour,
        x: g.x,
        y: g.y,
        w: g.w,
        h: g.h,
        collapsed: g.collapsed,
        fields
      });
    });

    const layer = document.getElementById("floatingLayer");
    if (layer) {
      layer.querySelectorAll(".floating-field").forEach(el => {
        const id = el.dataset.id;
        const field = floatingFields.find(f => f.id === id);
        if (!field) return;
        layout.floatingFields.push({
          id: field.id,
          fieldCode: field.fieldCode,
          label: field.label,
          x: field.x,
          y: field.y
        });
      });
    }

    return layout;
  }

  function applyLayout(layout) {
    const canvas = document.getElementById("canvas");
    canvas.innerHTML = "";

    groups = [];
    floatingFields = [];

    // Groups
    if (Array.isArray(layout.groups)) {
      layout.groups.forEach(g => {
        const group = {
          id: g.id || makeId("group"),
          title: g.title || g.id || "Group",
          colour: g.colour || "#4b5563",
          x: g.x || 20,
          y: g.y || 20,
          w: g.w || 260,
          h: g.h || 120,
          collapsed: !!g.collapsed,
          fields: Array.isArray(g.fields) ? g.fields : []
        };
        groups.push(group);
        const el = createGroupElement(group);
        canvas.appendChild(el);

        // Populate fields into body
        const body = el.querySelector(".group-body");
        group.fields.forEach(f => {
          const row = document.createElement("div");
          row.className = "field-row";
          row.dataset.fieldCode = f.fieldCode;
          const lbl = document.createElement("div");
          lbl.className = "field-label";
          lbl.textContent = f.label;
          const input = document.createElement("input");
          input.className = "field-input";
          input.placeholder = f.label;
          input.dataset.fieldCode = f.fieldCode;
          row.appendChild(lbl);
          row.appendChild(input);
          body.appendChild(row);
        });
      });
    }

    // Floating layer
    const floatLayer = document.createElement("div");
    floatLayer.id = "floatingLayer";
    floatLayer.style.position = "absolute";
    floatLayer.style.inset = "0";
    floatLayer.style.pointerEvents = "none";
    canvas.appendChild(floatLayer);

    // Floating fields
    if (Array.isArray(layout.floatingFields)) {
      layout.floatingFields.forEach(f => {
        addFloatingField(f.fieldCode, f.label, f.x || 40, f.y || 40);
      });
    }

    log("Layout applied from JSON");
  }

  function downloadLayout() {
    const layout = collectLayout();
    const blob = new Blob([JSON.stringify(layout, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "avd_layout.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    log("Layout saved as avd_layout.json");
  }

  function loadLayoutFromFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const layout = JSON.parse(ev.target.result);
        applyLayout(layout);
      } catch (err) {
        log("Error parsing layout JSON: " + err.message);
      }
    };
    reader.readAsText(file);
    e.target.value = "";
  }

  function resetLayout() {
    initGroups();
    log("Layout reset to defaults");
  }

  // ===== INIT =====
  window.addEventListener("DOMContentLoaded", function() {
    initGroups();
    initPalette();
    initCanvasDrop();
    log("Lotus-style layout designer ready");
  });
</script>
</body>
</html>
